# æµè§ˆå™¨å·¥ä½œåŸç†æ¡†æ¶

ç›®æ ‡ï¼š**å¼„æ¸…æ¥šæµè§ˆå™¨åŸºç¡€çš„å·¥ä½œåŸç†**

è¿‡ç¨‹ï¼šè‡ªå·±å®ç°ä¸€ä¸ªToy-Browseré¡¹ç›®ï¼Œå®ç°ä»urlåˆ°ä¸€ä¸ªBitmapçš„æ˜¾ç¤ºã€‚

![](images/image_6zck6v6NXC.png)

æµè§ˆå™¨å·¥ä½œåŸç†æ¶æ„å›¾ï¼š

1. ä¸€ä¸ªURLï¼Œé€šè¿‡HTTPè¯·æ±‚ï¼ŒHTTPå›åº”æ‹¿åˆ°htmlä»£ç 
2. htmlè¿›è¡Œparseè§£æåç”ŸæˆDomæ ‘
3. ä¸‹ä¸€æ­¥è¿›è¡ŒCSS computingï¼Œå¯¹Domæ ‘å¯¹åº”çš„cssè§„åˆ™è¿›è¡Œè®¡ç®—ï¼ˆå åŠ ï¼Œè¦†ç›–ç­‰ï¼‰
4. å¾—åˆ°å¸¦æ ·å¼çš„Domï¼ˆDom with cssï¼‰
5. ä¸‹ä¸€æ­¥ï¼Œlayoutå¸ƒå±€è®¡ç®—å‡ºæ¯ä¸ªDomç›’çš„ä½ç½®ï¼ˆDom with positionï¼‰
6. æœ€åä¸€æ­¥ï¼Œæ¸²æŸ“renderåˆ°ä¸€å¼ å›¾ç‰‡ä¸Š
7. é€šè¿‡æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶é©±åŠ¨æ˜¾ç¤ºå‡ºæ¥

> ğŸ“Œæˆ‘ä»¬çœ‹åˆ°çš„é¡µé¢ï¼Œä¸ç®¡æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡å­—éƒ½æ˜¯ä¸€ä¸ªå›¾ç‰‡å½¢å¼ï¼Œä¸“ä¸šç‚¹çš„è¯´æ³•å«åšä½å›¾ï¼ˆBitmapï¼‰ï¼Œç„¶åç»è¿‡æ˜¾å¡è½¬æ¢ä¸ºæˆ‘ä»¬å¯ä»¥è¯†åˆ«çš„å…‰ä¿¡å·ã€‚


# æœ‰é™çŠ¶æ€æœº

ç”±äºToy-Browserç»å¸¸éœ€è¦ä½¿ç”¨**æœ‰é™çŠ¶æ€æœºå¤„ç†å­—ç¬¦ä¸²**ï¼Œæ‰€ä»¥æœ‰å¿…è¦äº†è§£æœ‰é™çŠ¶æ€æœºã€‚

## æœ‰é™çŠ¶æ€æœº

**å¯¹åº”çš„åé¢ä¸æ˜¯æ— é™çŠ¶æ€æœºã€‚** æœ‰é™çŠ¶æ€æœºå¯ä»¥ç®€ç§°çŠ¶æ€æœºã€‚

1ã€æ¯ä¸ªçŠ¶æ€æœºéƒ½æ˜¯ä¸€ä¸ªï¼ˆæœºå™¨ï¼‰å‡½æ•°

- åœ¨æ¯ä¸ªæœºå™¨é‡Œï¼Œå¯ä»¥åšè®¡ç®—ï¼Œè¾“å‡ºç­‰
- æ‰€æœ‰æœºå™¨æ¥æ”¶çš„å‚æ•°æ˜¯ä¸€è‡´çš„
- çŠ¶æ€æœºçš„æ¯ä¸€ä¸ªæœºå™¨æœ¬èº«æ˜¯æ²¡æœ‰çŠ¶æ€çš„ï¼ˆç±»ä¼¼çº¯å‡½æ•°ï¼‰

2ã€æ¯ä¸ªæœºå™¨éƒ½çŸ¥é“è‡ªå·±çš„ä¸‹ä¸€ä¸ªçŠ¶æ€

- MooreçŠ¶æ€æœºï¼šæ¯ä¸ªæœºå™¨çš„ä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¯ç¡®å®šçš„ï¼Œè·Ÿè¾“å…¥æ— å…³
- MealyçŠ¶æ€æœºï¼šæ¯ä¸ªæœºå™¨çš„ä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¯ç”±è¾“å…¥å†³å®šçš„

MealyçŠ¶æ€æœºJavaScriptä¼ªä»£ç ç¤ºä¾‹ï¼š

```javascript
//æ¯ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªçŠ¶æ€
function state(input) {
  //... å…¶ä»–æ“ä½œ
  
  return nextState; // è¿”å›ä¸‹ä¸€ä¸ªçŠ¶æ€å‡½æ•°
} 


// ä¸€èˆ¬è°ƒç”¨è¿‡ç¨‹ï¼Œé€šè¿‡å¾ªç¯è·å–è¾“å…¥
while(input) {
  nextState = state(input);
} 
```

## ä¸ä½¿ç”¨çŠ¶æ€æœºå¤„ç†å­—ç¬¦ä¸²

ç»ƒä¹ 1ï¼šåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ‰¾åˆ°å­—ç¬¦â€œaâ€ï¼š

```javascript
function match(str,c) {
  return str.indexOf(c) !== -1;
}
```

ç»ƒä¹ 2ï¼šä¸å‡†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œçº¯ç²¹ç”¨ JavaScript çš„é€»è¾‘å®ç°ï¼šåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ‰¾åˆ°å­—ç¬¦â€œabâ€

```javascript
function match(str) {
    for(let i=0; i<str.length; i++) {
        if(str[i] == 'a' && str[i+1] == 'b') {
            return true;
        }
    }
    return false;
}

console.log(findAB('I am abcd'));
```

ç»ƒä¹ 3 ï¼šä¸å‡†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œçº¯ç²¹ç”¨ JavaScript çš„é€»è¾‘å®ç°ï¼šåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ‰¾åˆ°å­—ç¬¦â€œabcdâ€

```javascript
function match(str) {
    for(let i=0; i<str.length; i++) {
        if(str[i] == 'a' 
        && str[i+1] == 'b'
        && str[i+2] == 'c'
        && str[i+3] == 'd') {
            return true;
        }
    }
    return false;
}

console.log(findAB('I am aabcdeff dasds'));
```

## ä½¿ç”¨çŠ¶æ€æœºå¤„ç†å­—ç¬¦ä¸²

ç»ƒä¹ ï¼šåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ‰¾åˆ°å­—ç¬¦â€œabcdâ€ï¼ˆä½¿ç”¨çŠ¶æ€æœºçš„æ–¹å¼ï¼‰

```javascript
// é€šè¿‡æŸ¥æ‰¾æ¯ä¸ªå­—ç¬¦çš„çŠ¶æ€ï¼ŒæŸ¥åˆ°ååˆ°è¾¾ä¸‹ä¸€ä¸ªçŠ¶æ€
// åˆ°è¾¾endçŠ¶æ€åï¼Œé”æ­»åœ¨endçŠ¶æ€
function match(str) {
    let state = start;
    for (let c of str) {
        state = state(c);
    }
    return state === end;
}
function start(c) {
    if (c === 'a') {
        return findA;
    }
    return start;
}
function findA(c) {
    if (c === 'b') {
        return findB;
    }
    return start(c);
}
function findB(c) {
    if (c === 'c') {
        return findC;
    }
    return start(c);
}
function findC(c) {
    if (c === 'd') {
        return end;
    }
    return start(c);
}
function end(c) {
    return end;
}

console.log(match('I am ababcd'));
```

ç»ƒä¹ 2ï¼šç”¨çŠ¶æ€æœºå®ç°ï¼šå­—ç¬¦ä¸²â€œabcabxâ€çš„è§£æ

```javascript
function match(str) {
    let state = start;
    for (const c of str) {
        state = state(c);
    }
    console.log(state.name);
    return state === end;
}

function start(c) {
    if (c === 'a') return findA;
    return start;
}
function findA(c) {
    if (c === 'b') return findB;
    return start(c);
}
function findB(c) {
    if (c === 'c') return findC;
    return start(c);
}
function findC(c) {
    if (c === 'a') return findA2;
    return start(c);
}
function findA2(c) {
    if (c === 'b') return findB2;
    return start(c);
}
// å¦‚æœæœ€åä¸€ä¸ªä¸æ˜¯xï¼Œæœ‰å¯èƒ½æ˜¯cï¼Œèµ°findBé€»è¾‘ï¼Œå¦‚æœä¸æ˜¯cï¼Œè¿›å…¥startï¼Œé‡æ–°å¼€å§‹
function findB2(c) {
    if (c === 'x') return end;
    return findB(c); 
}
function end(c) {
    return end;
}

console.log(match('i am abcabcabx'));
```

ç»ƒä¹ 3ï¼šä½¿ç”¨çŠ¶æ€æœºå®Œæˆâ€abababxâ€çš„å¤„ç†ã€‚

```javascript
function match(str) {
    let state = start;
    for (const c of str) {
        state = state(c);
    }
    console.log(state.name);
    return state === end;
}

function start(c) {
    if (c === 'a') return findA;
    return start;
}
function findA(c) {
    if (c === 'b') return findB;
    return start(c);
}
function findB(c) {
    if (c === 'a') return findA2;
    return start(c);
}
function findA2(c) {
    if (c === 'b') return findB2;
    return start(c);
}
function findB2(c) {
    if (c === 'a') return findA3;
    return start(c);
}
function findA3(c) {
    if (c === 'b') return findB3;
    return start(c);
}
// å¦‚æœä¸æ˜¯xï¼Œå¯èƒ½æ˜¯aï¼Œå›åˆ°æŸ¥æ‰¾ç¬¬ä¸‰ä¸ªaçš„æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯aï¼Œé‡æ–°å¼€å§‹æŸ¥æ‰¾
function findB3(c) {
    if (c === 'x') return end;
    return findB2(c);
}
function end(c) {
    return end;
}

console.log(match('i am ababababx'));
```

## å­—ç¬¦ä¸²KMPç®—æ³•

ä½œä¸šï¼šå¦‚ä½•ç”¨çŠ¶æ€æœºå¤„ç†å®Œå…¨æœªçŸ¥çš„ patternï¼Ÿï¼ˆå‚è€ƒå­—ç¬¦ä¸²KMPç®—æ³•ï¼‰

[ KMP ç®—æ³•è¯¦è§£ è¯»å®Œæœ¬æ–‡ï¼Œä½ å¯ä»¥å»åŠ›æ‰£æ‹¿ä¸‹å¦‚ä¸‹é¢˜ç›®ï¼š 28.å®ç° strStr() -----------KMP ç®—æ³•ï¼ˆKnuth-Morris-Pratt ç®—æ³•ï¼‰æ˜¯ä¸€ä¸ªè‘—åçš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯ç¡®å®æœ‰ç‚¹å¤æ‚ã€‚ å¾ˆå¤šè¯»è€…æŠ±æ€¨ KMP ç®—æ³•æ— æ³•ç†è§£ï¼Œè¿™å¾ˆæ­£å¸¸ï¼Œâ€¦ https://zhuanlan.zhihu.com/p/83334559](https://zhuanlan.zhihu.com/p/83334559 " KMP ç®—æ³•è¯¦è§£ è¯»å®Œæœ¬æ–‡ï¼Œä½ å¯ä»¥å»åŠ›æ‰£æ‹¿ä¸‹å¦‚ä¸‹é¢˜ç›®ï¼š 28.å®ç° strStr() -----------KMP ç®—æ³•ï¼ˆKnuth-Morris-Pratt ç®—æ³•ï¼‰æ˜¯ä¸€ä¸ªè‘—åçš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯ç¡®å®æœ‰ç‚¹å¤æ‚ã€‚ å¾ˆå¤šè¯»è€…æŠ±æ€¨ KMP ç®—æ³•æ— æ³•ç†è§£ï¼Œè¿™å¾ˆæ­£å¸¸ï¼Œâ€¦ https://zhuanlan.zhihu.com/p/83334559")

[ å­—ç¬¦ä¸²åŒ¹é…çš„KMPç®—æ³• - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—  http://www.ruanyifeng.com/blog/2013/05/Knuthâ€“Morrisâ€“Pratt\_algorithm.html](http://www.ruanyifeng.com/blog/2013/05/Knuthâ€“Morrisâ€“Pratt_algorithm.html " å­—ç¬¦ä¸²åŒ¹é…çš„KMPç®—æ³• - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—  http://www.ruanyifeng.com/blog/2013/05/Knuthâ€“Morrisâ€“Pratt_algorithm.html")

```javascript

/**
 * æ„å»ºdp äºŒç»´æ•°ç»„
 * @param {*} pat æ¨¡å¼å­—ç¬¦ä¸²
 */
function kmp(pat) {
    let patLen = pat.length;

    // åˆå§‹åŒ–dpä¸º[patLen][256]äºŒç»´æ•°ç»„
    let dp = new Array(patLen).fill(0).map(() => new Array(256).fill(0));

    // dp[çŠ¶æ€][å­—ç¬¦] = ä¸‹ä¸ªçŠ¶æ€
    // åˆå§‹å€¼ï¼šå½“å‰çŠ¶æ€ä¸º0ï¼Œé‡åˆ°å­—ç¬¦pat[0]ï¼Œè½¬ç§»åˆ°ä¸‹ä¸ªçŠ¶æ€1
    dp[0][pat.charCodeAt(0)] = 1;

    // å½±å­çŠ¶æ€Xï¼Œåˆå§‹å€¼ä¸º0
    let X = 0;

    // j ä»1 å¼€å§‹
    for (let j = 1; j < patLen; j++) {
        for (let c = 0; c < 256; c++) {
            let s = String.fromCharCode(c); //ASCIIè½¬å­—ç¬¦
            if (pat[j] == s) {
                // çŠ¶æ€æ¨è¿›
                dp[j][c] = j + 1;
            } else {
                // çŠ¶æ€é‡å¯ï¼ˆäº¤ç”±å½±å­å¤„ç†ï¼Œå½±å­Xæ°¸è¿œæ¯”å½“å‰çŠ¶æ€ j è½åä¸€ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥å®ƒçŸ¥é“å½“å‰æ€ä¹ˆå¤„ç†ï¼Œå› ä¸ºjå·²ç»è¶Ÿè¿‡äº†ï¼‰
                dp[j][c] = dp[X][c];
            }
        }
        // æ›´æ–°å½±å­çŠ¶æ€ï¼ˆæŠŠå½“å‰jçš„çŠ¶æ€ç»™å½±å­ï¼Œç„¶åjç»§ç»­å¾€å‰èµ°ï¼Œç›¸å½“äºæ‰“äº†ä¸ªtagï¼‰
        // å½“å‰æ˜¯çŠ¶æ€ Xï¼Œé‡åˆ°å­—ç¬¦ pat[j]ï¼Œ
        // X åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿ
        X = dp[X][pat.charCodeAt(j)];
    }

    return dp;
}

/**
 * æŸ¥æ‰¾å‡½æ•°
 * @param {*} str æ–‡æœ¬å­—ç¬¦ä¸²
 * @param {*} pat æ¨¡å¼å­—ç¬¦ä¸²
 * @returns è¿”å›æ‰¾åˆ°patåœ¨strçš„ç´¢å¼•ï¼ˆè‹¥ä¸º -1ï¼Œæ²¡æ‰¾åˆ°ï¼‰
 */
function match(str, pat) {
    let strLen = str.length;
    let patLen = pat.length;

    // patçš„åˆå§‹çŠ¶æ€ä¸º0
    let j = 0;

    for (let i = 0; i < strLen; i++) {
        
        //å½“å‰çŠ¶æ€ä¸ºjï¼Œé‡åˆ°å­—ç¬¦str[i]ï¼Œpatåº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿ
        j = dp[j][str.charCodeAt(i)];

        if (j == patLen) {
            return i - patLen + 1;
        }
    }

    return -1;
}

let str = 'aababababx';
let pat = 'ababx';

let dp = kmp(pat);
let index = match(str, pat);

if (index !== -1) {
    console.log('åŒ¹é…æˆåŠŸï¼Œç´¢å¼•ä¸ºï¼š',index);
} else {
    console.log('åŒ¹é…å¤±è´¥');
}

// å‚è€ƒæ–‡æ¡£ï¼šhttps://zhuanlan.zhihu.com/p/83334559


```


# HTTPåè®®è§£æ

## ç›®æ ‡

è¿‡ç¨‹ï¼šè‡ªå·±å®ç°ä¸€ä¸ªToy-Browseré¡¹ç›®ï¼Œå®ç°ä»urlåˆ°ä¸€ä¸ªBitmapçš„æ˜¾ç¤ºã€‚

![](images/image_6zck6v6NXC.png)

æ‰€ä»¥ï¼Œé¦–å…ˆææ¸…æ¥šç¬¬ä¸€æ­¥ï¼Œä¸€ä¸ªURLï¼Œé€šè¿‡HTTPè¯·æ±‚ï¼ŒHTTPå›åº”æ‹¿åˆ°htmlä»£ç 

## ISO-OSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹

![](images/image_csFRzAU8-R.png)

**ç½‘ç»œå±‚**ï¼šInternetåè®®å°±æ˜¯IPåè®®ï¼Œæ•°æ®åŒ…å°±æ˜¯é€šè¿‡IPå”¯ä¸€æ ‡ç¤ºåœ°å€æ‰¾åˆ°ä»å“ªä¸ªè®¾å¤‡ä¼ è¾“åˆ°å“ªä¸ªè®¾å¤‡ã€‚æ²¡æœ‰å¯¹åº”çš„åº“ï¼Œä¼šè°ƒç”¨C++çš„`libnet`å’Œ`libpcap`ã€‚

**ä¼ è¾“å±‚**ï¼šTCPåè®®ï¼Œä¼ è¾“ä¸€ä¸ªä¸€ä¸ªæ•°æ®åŒ…ã€‚TCPå¯¹åº”ä¸€ä¸ªæ¦‚å¿µå«`ç«¯å£`ï¼ŒåŒºåˆ†å“ªä¸ªæ•°æ®åŒ…åˆ†é…ç»™å“ªä¸ªè½¯ä»¶ã€‚å¯¹åº”çš„åº“ä¸º`require('net')`ã€‚

**HTTPå±‚**ï¼šä¸èƒ½å¼•å…¥`require('http')` ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°httpåè®®ï¼Œæ‰€ä»¥åº”è¯¥å¼•å…¥`require('net')`ã€‚

## HTTP

- request
- response

requestå’Œresponseæ˜¯ä¸€å¯¹ä¸€å‡ºç°çš„ã€‚

æˆ‘ä»¬è¦å®ç°çš„httpåè®®å°±æ˜¯å®ç°requestå’Œresponseã€‚

HTTPåè®®æ˜¯æ–‡æœ¬å‹åè®®ã€‚è·ŸäºŒè¿›åˆ¶å‹åè®®ç›¸å¯¹çš„ã€‚

æ–‡æœ¬å‹åè®®æ„æ€æ˜¯åè®®çš„å†…å®¹éƒ½æ˜¯**å­—ç¬¦ä¸²**ã€‚

### HTTPè¯·æ±‚æŠ¥æ–‡æ ¼å¼

![](images/image_5SyMnXKCTm.png)

**è¯·æ±‚å¤´Request Headers**

- è¯·æ±‚è¡Œ Request lineï¼š`POST / HTTP/1.1`  postè¯·æ±‚ï¼Œè·¯å¾„ä¸º`/`ï¼Œç‰ˆæœ¬å·
- è¯·æ±‚å¤´headersï¼šåŒ…æ‹¬å¤šè¡Œkeyï¼Œvalueçš„å½¢å¼ï¼Œå·²ç©ºè¡Œç»“æŸ
- è¯·æ±‚ä½“bodyï¼šæ ¹æ®ContentTypeæ˜¾ç¤ºä¸åŒçš„æ ·å¼

![](images/image_VXOPKE3Nq_.png)

### HTTPå“åº”æŠ¥æ–‡æ ¼å¼

![](images/image_i9jhTGjaU9.png)

![](images/image_TIpjwv6_h6.png)

**å“åº”å¤´Response Headers**

- çŠ¶æ€è¡Œ status lineï¼š`HTTP/1.1 200 OK` ç‰ˆæœ¬å·ï¼ŒçŠ¶æ€ç ï¼ŒçŠ¶æ€æ–‡æœ¬
- å“åº”å¤´headersï¼šåŒ…æ‹¬å¤šè¡Œkeyï¼Œvalueçš„å½¢å¼ï¼Œå·²ç©ºè¡Œç»“æŸ
- å“åº”æ­£æ–‡bodyï¼šæ ¹æ®ContentTypeæ˜¾ç¤ºä¸åŒçš„æ ·å¼

![](images/image_lfTT_b7nBP.png)

chunk bodyï¼šnodeé»˜è®¤è¿”å›çš„ä¸€ç§bodyæ ¼å¼ã€‚ç”±16è¿›åˆ¶æ•°å­—ç‹¬å ä¸€è¡Œï¼Œä¸­é—´æ˜¯å†…å®¹ï¼Œç»“å°¾æ˜¯16è¿›åˆ¶0ã€‚

### **nodeæœåŠ¡ç«¯ä»£ç **

```javascript
const http = require('http');

const server = http.createServer((req, res) => {
    let body = [];

    req.on('error', (err) => {
        console.error(err);
    }).on('data', (chunk) => {
        body.push(chunk.toString());
    }).on('end', () => {
        body = Buffer.concat(body).toString();
        console.log('body:', body);
        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end('Hello World\n');
    });
});

server.listen(8080);

console.log('server start!');
```

### **nodeå®¢æˆ·ç«¯**

å®ç°HTTPçš„è¯·æ±‚ä»£ç ï¼š

#### 1ã€æ„å»ºè¯·æ±‚å¤´ä¿¡æ¯

é€šè¿‡è‡ªå®šä¹‰`Request` ç±»æ¥è¿›è¡Œè¯·æ±‚å¤´çš„æ„å»ºã€‚

ä¸‹ä¸€æ­¥å®ç°`send`å‡½æ•°ï¼Œsendå‡½æ•°ä¸ºæŠŠè¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ã€‚

```javascript
class Request {
    constructor(option) {
        this.method = option.method || 'GET';
        this.host = option.host;
        this.port = option.port || '80';
        this.path = option.path || '/';
        this.body = option.body || {};
        this.headers = option.headers || {};

        if (!this.headers['Content-Type']) {
            this.headers['Content-Type'] = 'application/x-www-form-urlencoded';
        }
        if (this.headers['Content-Type'] === 'application/json') {
            this.bodyText = JSON.stringify(this.body);
        } else if (this.headers['Content-Type'] === 'application/x-www-form-urlencoded') {
            this.bodyText = Object.keys(this.body).map(key => `${key}=${encodeURIComponent(this.body[key])}`).join('&')
        }

        this.headers['Content-Length'] = this.bodyText.length;
    }

    send() {
        // ...
    }
}

void async function () {
    let req = new Request({
        method: 'POST',      // httpåè®®è¦æ±‚
        host: '127.0.0.1',   // ipåè®®è¦æ±‚
        port: '8080',        // tcpåè®®è¦æ±‚
        path: '/',           // httpåè®®è¦æ±‚
        headers: {
            ['X-Foo2']: 'customed'
        },
        body: {
            name: 'Daotin',
            age: '18'
        }
    });

    let res = await req.send();

    console.log(res);
}();
```

#### 2ã€ç¼–å†™sendå‡½æ•°

å‘é€è¯·æ±‚å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥è¿”å›Promiseã€‚

å‘é€çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŒç»­å—åˆ°æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ”¶åˆ°å…¨éƒ¨æ•°æ®åï¼Œå†æ•´åˆæˆä¸€ä¸ªæ¶ˆæ¯ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªç±»`ResponseParser`ï¼Œç”¨æ¥æ•´åˆæ•°æ®ã€‚

```javascript
send() {
    // å‘é€è¯·æ±‚å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥è¿”å›Promiseã€‚
    return new Promise((resolve, reject) => {
        const parser = new ResponseParser;
    });
}
```

```javascript
class ResponseParser {
    constructor() { }
    // æ¥æ”¶æ•°æ®
    receive(string) {
        for (let i = 0; i < string.length; i++) {
            this.receiveChar(string[i]);
        }
    }
    // çŠ¶æ€æœºä»£ç 
    receiveChar(char) {}
}
```

#### 3ã€ç¼–å†™sendå…·ä½“å‘é€è¯·æ±‚ä»£ç 

- æ”¯æŒå·²æœ‰çš„connectionæˆ–è€…æ–°å»ºçš„connection
- å‘é€åæ”¶åˆ°æœåŠ¡å™¨å“åº”æ•°æ®ä¼ ç»™parser
- æ ¹æ®parserçš„çŠ¶æ€è®¾ç½®resolveæˆ–è€…reject

```javascript
var net = require('net');

// æŠŠè¯·æ±‚å‘é€åˆ°nodeæœåŠ¡å™¨server.js
send(connection) {
    return new Promise((resolve, reject) => {
        // åˆ›å»ºä¸€ä¸ªå¤„ç†å“åº”æ•°æ®çš„ç±»ResponseParser
        const parser = new ResponseParser;
        
        // åˆ¤æ–­å½“å‰ä½¿ç”¨æœ‰TCPè¿æ¥ï¼Œå¦‚æœæœ‰ç›´æ¥å‘é€ï¼Œå¦‚æœæ²¡æœ‰æ–°åˆ›å»ºä¸€ä¸ªè¿æ¥
        if (connection) {
            // ç”±äºHTTPåè®®æ˜¯æ–‡æœ¬å‹åè®®ï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹å‡ä¸ºå­—ç¬¦ä¸²
            connection.write(this.reqDatatoString());
        } else {
            connection = net.createConnection({
                host: this.host,
                port: this.port
            }, () => {
                connection.write(this.reqDatatoString());
            });
        }

        // å¦‚æœæœåŠ¡å™¨æœ‰è¿”å›æ¶ˆæ¯ï¼Œä¼šè§¦å‘dataäº‹ä»¶
        connection.on('data', (data) => {
            // ä¸‹é¢æ˜¯æ‹¿åˆ°dataçš„ç¤ºä¾‹å†…å®¹ï¼š
            /*
                HTTP/1.1 200 OK
                Content-Type: text/html
                Date: Wed, 14 Apr 2021 15:13:17 GMT
                Connection: keep-alive
                Keep-Alive: timeout=5
                Transfer-Encoding: chunked

                c
                Hello World

                0
            */
            console.log(data.toString());
            parser.receive(data.toString());

            // parserå¤„ç†å­—ç¬¦ä¸²å®Œæˆ
            if (parser.isFinished) {
                resolve(parser.response);
                connection.end();
            }
        });

        connection.on('error', (err) => {
            reject(err)
            connection.end();
        });
    });
}

// æŠŠè¦å‘é€çš„è¯·æ±‚è½¬æ¢æˆå­—ç¬¦ä¸²å½¢å¼ï¼Œå› ä¸ºHTTPæ˜¯æ–‡æœ¬å‹åè®®
reqDatatoString() {
        return `${this.method} ${this.path} HTTP/1.1\r
${Object.keys(this.headers).map(key => `${key}: ${this.headers[key]}`).join('\r\n')}
\r
${this.bodyText}`;
    }

```

#### 4ã€ç¼–å†™å¤„ç†å“åº”æ•°æ®çš„parserä»£ç 

- å“åº”æ•°æ®æ˜¯å­—ç¬¦ä¸²ï¼Œä¸€ä¸ªä¸ªå­—ç¬¦æ¥æ”¶åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦parserä¸“é—¨å¤„ç†è¿™äº›å­—ç¬¦ä¸²
- ä½¿ç”¨çŠ¶æ€æœºè¡¨ç¤ºæ¥æ”¶å­—ç¬¦åˆ°å“ªä¸ªçŠ¶æ€äº†ï¼ˆæ¯”å¦‚status lineæ¥æ”¶å®Œäº†ï¼Œå¼€å§‹æ¥å—headersäº†ï¼‰

```javascript
/**
 * å¤„ç†å“åº”æ•°æ®çš„ç±»ï¼ŒæŠŠæ”¶åˆ°çš„æ–­æ–­ç»­ç»­çš„æ•°æ®ï¼Œæ•´åˆæˆä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…
 */
class ResponseParser {
    constructor() {
        /**
         * ä½¿ç”¨å¸¸é‡è¡¨ç¤ºæ¥æ”¶åˆ°å“åº”æ•°æ®çš„è¿›åº¦çŠ¶æ€
         * æ¢è¡Œæ—¶\r\n
         * æ¥æ”¶åˆ°\rè¿›å…¥ä¸‹ä¸€çŠ¶æ€ï¼Œ\nä¹Ÿæ˜¯ä¸€æ ·
         */
        this.WAITING_STATUS_LINE = 0; // å¤„åœ¨ç­‰å¾…çŠ¶æ€è¡ŒçŠ¶æ€ï¼ˆæ¥æ”¶åˆ°\rè¿›å…¥WAITING_STATUS_LINE_ENDçŠ¶æ€ï¼‰
        this.WAITING_STATUS_LINE_END = 1; // æ¥æ”¶åˆ°çŠ¶æ€è¡Œåé¢çš„\r,å¤„åœ¨ç­‰å¾…\nçŠ¶æ€ ï¼ˆæ¥æ”¶åˆ°\nè¿›å…¥WAITING_HEADER_NAMEçŠ¶æ€)

        this.WAITING_HEADER_NAME = 2; // ç­‰å¾…å“åº”å¤´key
        this.WAITING_HEADER_SPACE = 3; // ç­‰å¾…å“åº”å¤´keyå’Œvalueä¸­é—´çš„ç©ºæ ¼
        this.WAITING_HEADER_VALUE = 4; // ç­‰å¾…å“åº”å¤´value
        this.WAITING_HEADER_END = 5; // ç­‰å¾…å“åº”å¤´éƒ¨åˆ†æ¥æ”¶å®Œæ¯•
        this.WAITING_HEADER_BLOCK_END = 6; //ç­‰å¾…å“åº”å¤´ä¸å“åº”æ­£æ–‡ä¸­é—´çš„ç©ºè¡Œ

        this.WAITING_BODY = 7; // ç­‰å¾…å“åº”æ­£æ–‡éƒ¨åˆ†

        // è½¬æ¢åçš„å­˜æ”¾å“åº”æ•°æ®
        this.current = this.WAITING_STATUS_LINE;
        this.statusLine = '';
        this.headers = {};
        this.headerName = '';
        this.headerValue = '';
    }
    receive(string) {
        for (let i = 0; i < string.length; i++) {
            this.receiveChar(string[i]);
        }
        console.log('-->', this.statusLine);
        console.log('-->', this.headers);
    }
    // ä½¿ç”¨çŠ¶æ€æœºå¤„ç†
    receiveChar(char) {
        if (this.current === this.WAITING_STATUS_LINE) {
            if (char === '\r') {
                this.current = this.WAITING_STATUS_LINE_END;
            } else {
                this.statusLine += char;
            }
        } else if (this.current === this.WAITING_STATUS_LINE_END) {
            if (char === '\n') {
                this.current = this.WAITING_HEADER_NAME;
            }
        } else if (this.current === this.WAITING_HEADER_NAME) {
            if (char === ':') {
                this.current = this.WAITING_HEADER_SPACE;
            } else if (char === '\r') { // é‡åˆ°ç©ºè¡Œ
                this.current = this.WAITING_HEADER_BLOCK_END;
                // åˆ¤æ–­å“åº”æ•°æ®bodyçš„ç±»å‹ï¼ˆè¿™é‡Œæ˜¯chunkedæ ¼å¼çš„bodyï¼Œè¿˜ä¼šæœ‰å…¶ä»–æ ¼å¼çš„bodyï¼Œè¿™é‡Œnodeé»˜è®¤ä¸ºchunkedæ ¼å¼ï¼Œè‡³äºå…¶ä»–æ ¼å¼æš‚ä¸å¤„ç†ï¼‰
                if (this.headers['Transfer-Encoding'] === 'chunked') {
                    this.bodyParser = new ThunkedBodyParser();
                }
            } else {
                this.headerName += char;
            }
            
        } else if (this.current === this.WAITING_HEADER_SPACE) {
            if (char === ' ') {
                this.current = this.WAITING_HEADER_VALUE;
            }
        } else if (this.current === this.WAITING_HEADER_VALUE) {
            if (char === '\r') {
                this.current = this.WAITING_HEADER_END;
                this.headers[this.headerName] = this.headerValue;
                this.headerName = '';
                this.headerValue = '';
            } else {
                this.headerValue += char;
            }
        } else if (this.current === this.WAITING_HEADER_END) {
            if (char === '\n') {
                this.current = this.WAITING_HEADER_NAME;
            }
        } else if (this.current === this.WAITING_HEADER_BLOCK_END) {
            if (char === '\n') {
                this.current = this.WAITING_BODY;
            }
        } else if (this.current === this.WAITING_BODY) {
            this.bodyParser.receiveChar(char);
        }
    }
}
```

#### 5ã€ç¼–å†™bodyParserä»£ç 

- nodeé»˜è®¤çš„bodyæ ¼å¼ä¸ºchunkedæ ¼å¼ï¼Œè‡³äºå…¶ä»–æ ¼å¼æš‚ä¸å¤„ç†
- ä½¿ç”¨çŠ¶æ€æœºå¤„ç†bodyçš„æ ¼å¼

**chunkedæ ¼å¼å‚è€ƒæ–‡æ¡£ï¼š**

- [Transfer-Encodingâ€”â€”MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Transfer-Encoding "Transfer-Encodingâ€”â€”MDN")
- [HTTP åè®®å…¥é—¨â€”â€”é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2016/08/http.html "HTTP åè®®å…¥é—¨â€”â€”é˜®ä¸€å³°")
- [http åè®®çš„ç»“æŸç¬¦](https://github.com/jinhailang/blog/issues/34 "http åè®®çš„ç»“æŸç¬¦")

> ğŸ’¡ç»ˆæ­¢å—0æ˜¯ä¸€ä¸ªå¸¸è§„çš„åˆ†å—ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶é•¿åº¦ä¸º0ã€‚ç»ˆæ­¢å—åé¢æ˜¯ä¸€ä¸ªæŒ‚è½½ï¼ˆtrailerï¼‰ï¼Œç”±ä¸€ç³»åˆ—ï¼ˆæˆ–è€…ä¸ºç©ºï¼‰çš„å®ä½“æ¶ˆæ¯é¦–éƒ¨æ„æˆã€‚ï¼ˆä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œ0åé¢æ˜¯æœ‰`ä¸¤ä¸ª\r\n`çš„ï¼‰

ä¸€ä¸ªåˆ†å—å“åº”å½¢å¼å¦‚ä¸‹ï¼š

```çº¯æ–‡æœ¬
HTTP/1.1 200 OK
Content-Type: text/plain
Transfer-Encoding: chunked

7\r\n
Mozilla\r\n
9\r\n
Developer\r\n
7\r\n
Network\r\n
0\r\n
\r\n
```

![](images/image_eR3vtC7DMB.png)

```javascript

class ThunkedBodyParser {
    constructor() {
        /** bodyæ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š
         * ç¬¬ä¸€è¡Œä¸ºæ•°æ®é•¿åº¦ï¼Œ16è¿›åˆ¶çš„
         * ç¬¬äºŒè¡Œå¼€å§‹ä¸ºæ•°æ®å†…å®¹ã€‚
         * å½“æ•°æ®é•¿åº¦ä¸º0æ—¶ï¼Œbodyç»“æŸã€‚
         * 
           c
           Hello World

           0
         */
        this.WAITING_LENGTH = 0;      // ç­‰å¾…æ•°æ®é•¿åº¦
        this.WAITING_LENGTH_END = 1;

        this.WAITING_CHUNK = 2;   // ç­‰åˆ°bodyæ­£æ–‡

        this.WAITING_NEW_LINE = 3;  // æ–°çš„bodyæ•°æ®
        this.WAITING_NEW_LINE_END = 4;

        this.current = this.WAITING_LENGTH;
        this.length = 0;
        this.content = '';
        this.isFinished = false;
    }

    receiveChar(char) {
        if (this.current === this.WAITING_LENGTH) {
            if (char === '\r') {
                if (this.length === 0) {
                    this.isFinished = true;
                } else {
                    this.current = this.WAITING_LENGTH_END;
                }
            } else {
                this.length *= 16;
                this.length += parseInt(char, 16);
            }
        } else if (this.current === this.WAITING_LENGTH_END) {
            if (char === '\n') {
                this.current = this.WAITING_CHUNK;
            }
        } else if (this.current === this.WAITING_CHUNK) {
            this.content += char;
            this.length--;
            if (this.length === 0) {
                this.current = this.WAITING_NEW_LINE;
            }
        } else if (this.current === this.WAITING_NEW_LINE) {
            if (char === '\r') {
                this.current = this.WAITING_NEW_LINE_END;
            }
        } else if (this.current === this.WAITING_NEW_LINE_END) {
            if (char === '\n') {
                this.current = this.WAITING_LENGTH;
            }
        }
    }
}
```

## æ€»ç»“

1. æ„å»ºæœåŠ¡ç«¯`server.js`
2. æ„å»ºå®¢æˆ·ç«¯`client.js`
3. åˆ›å»ºè¯·æ±‚å‘é€ç±»`Request`ï¼Œé€šè¿‡sendå‘é€è¯·æ±‚ï¼ˆé€šè¿‡`async/await` å¼‚æ­¥å‘é€è¯·æ±‚ï¼Œå‘é€çš„è¿‡ç¨‹ä¸ä¼šé˜»å¡åé¢ä»£ç æ‰§è¡Œï¼Œå…³äºasyncï¼Œè¿™ç¯‡æ–‡ç« å¾ˆå¥½ï¼š[https://www.jianshu.com/p/fb1da22f335d](https://www.jianshu.com/p/fb1da22f335d "https://www.jianshu.com/p/fb1da22f335d")ï¼‰
4. æ„å»º`ResponseParser` å¤„ç†æœåŠ¡ç«¯è¿”å›çš„æ•°æ®ï¼ˆåˆ©ç”¨`çŠ¶æ€æœº`å¤„ç†çŠ¶æ€è¡Œï¼Œå“åº”å¤´ï¼‰
5. åˆ›å»º`ThunkedBodyParser` å¤„ç†å“åº”æ­£æ–‡ï¼ˆåˆ©ç”¨`çŠ¶æ€æœº`å¤„ç†ï¼‰
6. æœ€å`req.send()` çš„è¿”å›å€¼å°±æ˜¯å¤„ç†å¥½çš„å“åº”æ•°æ®


# HTMLè§£æç”ŸæˆDOMæ ‘

## ç›®æ ‡

![](images/image_6zck6v6NXC.png)

æˆ‘ä»¬å·²ç»å®Œæˆç¬¬ä¸€æ­¥ï¼šä»httpè¯·æ±‚ï¼Œhttpå›åº”æ‹¿åˆ°htmlä»£ç ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°ç¬¬äºŒæ­¥ï¼šhtmlè¿›è¡Œparseè§£æåç”ŸæˆDomæ ‘

## è¿‡ç¨‹

é¦–å…ˆæ–°å»º`parser.js`æ–‡ä»¶ä¸“é—¨å¤„ç†åç»­çš„è§£æè¿‡ç¨‹ã€‚

å…¶ä¸­`parseHTML`å‡½æ•°å°±æ˜¯è§£æHTMLçš„è¿‡ç¨‹ã€‚

```javascript
// client.js
let dom = parser.parseHTML(response.body);

// parser.js
exports.parseHTML = function (html) {
    console.log('-->', html);
} 
```

## HTMLè§£æï¼ˆè¯æ³•åˆ†æï¼‰

htmlè§£æè¿‡ç¨‹ä¹Ÿæ˜¯ä½¿ç”¨çŠ¶æ€æœºæ¥å¤„ç†ï¼Œä¸è¿‡ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰çŠ¶æ€ï¼Œåœ¨HTMLçš„æ ‡å‡†é‡Œé¢å°±å·²ç»å¸®æˆ‘ä»¬è®¾è®¡å¥½äº†80ä¸ªçŠ¶æ€ï¼ˆ**13.2.5 Tokenization**ç« èŠ‚ï¼‰ã€‚æˆ‘ä»¬åªéœ€è¦æ ¹æ®çŠ¶æ€æ¥åˆ¤æ–­å°±å¥½äº†ã€‚

[ HTML Standard  https://html.spec.whatwg.org/multipage/parsing.html](https://html.spec.whatwg.org/multipage/parsing.html " HTML Standard  https://html.spec.whatwg.org/multipage/parsing.html")

ä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œå¤§éƒ¨åˆ†çŠ¶æ€æ˜¯ä¸éœ€è¦çš„ï¼Œåªéœ€è¦åå‡ ä¸ªã€‚

```javascript
const EOF = Symbol('EOF'); // end of file

function data(c) {
    
}

exports.parseHTML = function (html) {
    let state = data;
    for (const c of html) {
        state = state(c);
    }
    // htmlæœ€åæ˜¯æœ‰ä¸€ä¸ªæ–‡ä»¶ç»ˆç»“çš„ï¼Œä½†æ˜¯åœ¨æ–‡ä»¶ç»ˆç»“çš„ä½ç½®ï¼Œæ¯”å¦‚è¯´æœ‰ä¸€äº›æ–‡æœ¬èŠ‚ç‚¹å¯èƒ½ä»ç„¶é¢ä¸´æ²¡æœ‰ç»ˆç»“çš„çŠ¶æ€ï¼Œæ‰€ä»¥æœ€åç»™å®ƒä¸€ä¸ªé¢å¤–çš„æ— æ•ˆçš„å­—ç¬¦ï¼Œè¡¨ç¤ºhtmlçš„ç»ˆç»“
    state = state(EOF);
}
```

æˆ‘çš„é—®é¢˜â“â“â“

## è§£ææ ‡ç­¾tag

æ ‡ç­¾åˆ†ä¸ºä¸‰ç§ï¼š

- å¼€å§‹æ ‡ç­¾`<input>`
- ç»“æŸæ ‡ç­¾`</input>`
- è‡ªé—­åˆæ ‡ç­¾`<input />`

æˆ‘ä»¬éœ€è¦åˆ¤æ–­é‡åˆ°çš„æ ‡ç­¾æ˜¯ä»¥ä¸Šä¸‰ç§çš„å“ªä¸€ç§ã€‚

```javascript

const EOF = Symbol('EOF'); // end of file

// åˆå§‹çŠ¶æ€ï¼Œå› ä¸ºHTMLæ ‡å‡†è§„å®šä¸­åˆå§‹çŠ¶æ€ç”¨çš„æ˜¯data
function data(c) {
    if (c === '<') {
        return tagOpen;
    } else if (c == EOF) {
        return;
    } else {
        return data;
    }
}

// æ˜¯tagæ ‡ç­¾çŠ¶æ€
function tagOpen(c) {
    if (c === '/') {
        return endTagOpen;
    } else if (c.match(/^[a-zA-Z]$/)) {
        return tagName(c);
    } else {
        return;
    }
}

// æ˜¯æ ‡ç­¾åç§°çŠ¶æ€
function tagName(c) {
    if (c.match(/^[\t\n\f ]$/)) { // 4ä¸ªæœ‰æ•ˆç©ºæ ¼
        return beforeAttributeName;
    } else if (c.match(/^[a-zA-Z]$/)) {
        return tagName;
    } else if (c === '/') {
        return selfClosingTag;
    } else if(c === '>'){ // åŒ¹é…åˆ°å®Œæ•´çš„å¼€å§‹æ ‡ç­¾ï¼Œè¿›å…¥dataï¼Œå¼€å§‹åŒ¹é…ä¸‹ä¸€ä¸ªæ ‡ç­¾
        return data;
    } else {
        return;
    }
}

// æ˜¯å±æ€§åçŠ¶æ€ï¼ˆæš‚æœªå¤„ç†ï¼‰
function beforeAttributeName(c) {
    if (c.match(/^[\t\n\f ]$/)) {
        return beforeAttributeName;
    } else if (c === '>') {
        return data;
    } else if (c === '=') {
        return beforeAttributeName;
    } else {
        return beforeAttributeName;
    } 
}

// æ˜¯è‡ªé—­åˆæ ‡ç­¾çŠ¶æ€
function selfClosingTag(c) {
    if (c === '>') {
        // æ˜¯è‡ªé—­åˆæ ‡ç­¾
        return data;
    } else if(c === EOF){
        return;
    } else {
        return;
    }
}

exports.parseHTML = function (html) {
    let state = data;
    for (const c of html) {
        state = state(c);
    }
    // æœ€åç»™ä¸€ä¸ªæ— æ•ˆçš„å­—ç¬¦ï¼Œè¡¨ç¤ºhtmlçš„ç»ˆç»“
    state = state(EOF);
}
```

> ğŸ’¡4ä¸ªæœ‰æ•ˆç©ºæ ¼ï¼š`\t` `\n` `\f` ` ` ã€‚

## åŠ å…¥ä¸šåŠ¡é€»è¾‘

- å¢åŠ `currentToken`è®°å½•å½“å‰æ ‡ç­¾çš„ç±»å‹typeå’Œæ ‡ç­¾åç§°nameï¼Œ
- å¢åŠ `emit`å‡½æ•°è¾“å‡ºæ¯ä¸ªå­—ç¬¦æ˜¯æ–‡æœ¬ç±»å‹è¿˜æ˜¯æ ‡ç­¾

```javascript

const EOF = Symbol('EOF'); // end of file

let currentToken = null;

function emit(token) {
    console.log('-->', token);
}

// åˆå§‹çŠ¶æ€ï¼Œå› ä¸ºHTMLæ ‡å‡†è§„å®šä¸­åˆå§‹çŠ¶æ€ç”¨çš„æ˜¯data
function data(c) {
    if (c === '<') {
        return tagOpen;
    } else if (c == EOF) {
        emit({
            type: 'EOF'
        });
        return;
    } else {
        // æ‰“å°æ¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹
        emit({
            type: 'text',
            content: c
        });
        return data;
    }
}

// æ˜¯tagæ ‡ç­¾çŠ¶æ€
function tagOpen(c) {
    if (c === '/') {
        return endTagOpen;
    } else if (c.match(/^[a-zA-Z]$/)) {
        currentToken = {
            type: 'startTag',
            tagName: ''
        };
        return tagName(c);
    } else {
        return;
    }
}

// æ˜¯ç»“æŸæ ‡ç­¾
function endTagOpen(c) {
    if (c.match(/^[a-zA-Z]$/)) {
        currentToken = {
            type: 'endTag',
            tagName: ''
        };
        return tagName(c);
    } else if (c === '>') {
        
    } else if (c === EOF) {

    } else {
        
    }
}

// æ˜¯æ ‡ç­¾åç§°çŠ¶æ€
function tagName(c) {
    if (c.match(/^[\t\n\f ]$/)) { // 4ä¸ªæœ‰æ•ˆç©ºæ ¼
        return beforeAttributeName;
    } else if (c.match(/^[a-zA-Z]$/)) {
        currentToken.tagName += c;
        return tagName;
    } else if (c === '/') {
        return selfClosingStartTag;
    } else if (c === '>') { // åŒ¹é…åˆ°å®Œæ•´çš„å¼€å§‹æ ‡ç­¾ï¼Œè¿›å…¥dataï¼Œå¼€å§‹åŒ¹é…ä¸‹ä¸€ä¸ªæ ‡ç­¾
        emit(currentToken); // æ‰“å°æ ‡ç­¾
        return data;
    } else {
        return;
    }
}

// æ˜¯å±æ€§åçŠ¶æ€
function beforeAttributeName(c) {
    if (c.match(/^[\t\n\f ]$/)) {
        return beforeAttributeName;
    } else if (c === '>') {
        emit(currentToken); // æ‰“å°æ ‡ç­¾
        return data;
    } else if (c === '=') {
        return beforeAttributeName;
    } else {
        return beforeAttributeName;
    } 
}

// æ˜¯è‡ªé—­åˆæ ‡ç­¾çŠ¶æ€
function selfClosingStartTag(c) {
    if (c === '>') {
        // æ˜¯è‡ªé—­åˆæ ‡ç­¾
        currentToken.isSelfClosing = true;
        return data;
    } else if(c === EOF){
        return;
    } else {
        return;
    }
}

exports.parseHTML = function (html) {
    let state = data;
    for (const c of html) {
        state = state(c);
    }
    // æœ€åç»™ä¸€ä¸ªæ— æ•ˆçš„å­—ç¬¦ï¼Œè¡¨ç¤ºhtmlçš„ç»ˆç»“
    state = state(EOF);
}
```

æ‰“å°ç»“æœçš„ä¸€éƒ¨åˆ†ï¼š

![](images/image_PleCFl6O09.png)

## è§£ææ ‡ç­¾å±æ€§

- å±æ€§å€¼åˆ†ä¸º`å•å¼•å·`ï¼Œ`åŒå¼•å·`ï¼Œ`æ— å¼•å·`ä¸‰ç§å†™æ³•ã€‚
- ä½¿ç”¨å…¨å±€å˜é‡`currentAttribute`æš‚å­˜å±æ€§åå’Œå±æ€§å€¼ã€‚
- å±æ€§ç»“æŸæ—¶ï¼ŒæŠŠå±æ€§å†™åˆ°æ ‡ç­¾Tokenä¸Šã€‚

ä»£ç å¤ªé•¿å°±çœç•¥äº†ã€‚ã€‚

![](images/image_wWqN4U9jpZ.png)

åŸserverä¸­çš„htmlä»£ç å¦‚ä¸‹ï¼š

```html
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Document</title>
    </head>
    <body>
        <div id="box">
            <input />
            <input class='ipt' />    
            <span attr=abc >Hello World</span>
        </div>
    </body>
</html>
```

å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºçš„tokenå¸¦æœ‰å±æ€§ã€‚

## HTMLè¯­æ³•åˆ†æ

ç”¨æ ˆæ„å»ºdomæ ‘åŸç†

- é‡åˆ°`å¼€å§‹æ ‡ç­¾`åˆ›å»ºå…ƒç´ å¹¶å…¥æ ˆ
- é‡åˆ°`ç»“æŸæ ‡ç­¾`å°±å‡ºæ ˆ
- `è‡ªé—­åˆæ ‡ç­¾`å¯ä»¥è§†ä¸ºå…¥æ ˆåç«‹åˆ»å‡ºæ ˆ
- ä»»ä½•å…ƒç´ çš„çˆ¶å…ƒç´ éƒ½æ˜¯å…¶å…¥æ ˆå‰çš„`æ ˆé¡¶å…ƒç´ `

### æ„å»ºdomæ ‘çš„æ ‡ç­¾èŠ‚ç‚¹

```javascript
// æ ˆæœ¬æ¥æ˜¯ç©ºçš„ï¼Œè¿™é‡Œç»™ä¸ªåˆå§‹æ ¹å…ƒç´ ï¼Œæ–¹ä¾¿è¾“å‡ºè§‚çœ‹
let stack = [{ type: 'document', children: [] }];

function emit(token) {
    let top = stack[stack.length-1];

    // å¼€å§‹æ ‡ç­¾ï¼Œæ„å»ºå…ƒç´ å±æ€§ï¼Œç„¶åå…¥æ ˆ
    if (token.type === 'startTag') {
        let element = {
            type: 'element',
            tagName: token.tagName,
            attributes: [],
            parent: top,
            children:[]
        }
        // æ‰€æœ‰çš„æ ‡ç­¾å±æ€§
        for (const k in token) {
            if (k !== 'type' && k !== 'tagName') {
                element.attributes.push({
                    name: k,
                    value: token[k]
                });
            }
        }
        //ä»»ä½•å…ƒç´ çš„çˆ¶å…ƒç´ éƒ½æ˜¯å…¶å…¥æ ˆå‰çš„æ ˆé¡¶å…ƒç´ 
        top.children.push(element);

        // ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ‰å…¥æ ˆ
        if (!token.isSelfClosing) {
            stack.push(element);
        }
    } else if (token.type === 'endTag') { // åŒ¹é…åˆ°ç»“æŸæ ‡ç­¾å‡ºæ ˆ
        if (top.tagName === token.tagName) {
            stack.pop();
        } else {
            throw new Error('endTag not match startTag!');
        }
    }
}
```

æœ€åè¾“å‡ºçš„stackå¦‚ä¸‹ï¼š

```json
[
  {
    type: "document",
    children: [
      {
        type: "element",
        tagName: "html",
        attributes: [
          {
            name: "lang",
            value: "en",
          },
        ],
        parent: [Circular],
        children: [
          {
            type: "element",
            tagName: "head",
            attributes: [
            ],
            parent: [Circular],
            children: [
              {
                type: "element",
                tagName: "meta",
                attributes: [
                  {
                    name: "charset",
                    value: "UTF-8",
                  },
                  {
                    name: "isSelfClosing",
                    value: true,
                  },
                ],
                parent: [Circular],
                children: [
                ],
              },
              {
                type: "element",
                tagName: "title",
                attributes: [
                ],
                parent: [Circular],
                children: [
                ],
              },
            ],
          },
          {
            type: "element",
            tagName: "body",
            attributes: [
            ],
            parent: [Circular],
            children: [
              {
                type: "element",
                tagName: "div",
                attributes: [
                  {
                    name: "id",
                    value: "box",
                  },
                ],
                parent: [Circular],
                children: [
                  {
                    type: "element",
                    tagName: "input",
                    attributes: [
                      {
                        name: "isSelfClosing",
                        value: true,
                      },
                    ],
                    parent: [Circular],
                    children: [
                    ],
                  },
                  {
                    type: "element",
                    tagName: "input",
                    attributes: [
                      {
                        name: "class",
                        value: "ipt",
                      },
                      {
                        name: "isSelfClosing",
                        value: true,
                      },
                    ],
                    parent: [Circular],
                    children: [
                    ],
                  },
                  {
                    type: "element",
                    tagName: "span",
                    attributes: [
                      {
                        name: "attr",
                        value: "abc",
                      },
                    ],
                    parent: [Circular],
                    children: [
                    ],
                  },
                ],
              },
            ],
          },
        ],
      },
    ],
  },
]
```

### æ„å»ºdomæ ‘çš„æ–‡æœ¬èŠ‚ç‚¹

åœ¨ä¹‹å‰emitå‡½æ•°çš„åŸºç¡€ä¸Šï¼Œå¢åŠ æ–‡æœ¬èŠ‚ç‚¹çš„å¤„ç†

- æ–°å¢å½“å‰æ–‡æœ¬èŠ‚ç‚¹currentTextNodeï¼Œå¦‚æœé‡åˆ°tokenä¸ºæ ‡ç­¾èŠ‚ç‚¹ï¼ŒcurrentTextNode=null
- currentTextNodeä¸ºnullï¼Œè¯´æ˜æ˜¯æ–°çš„æ–‡æœ¬èŠ‚ç‚¹åŠ å…¥topçš„children
- currentTextNodeä¸ä¸ºnullï¼Œè¯´æ˜ä¸Šä¸€ä¸ªtokenä¹Ÿæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±åˆå¹¶ä¸ºåŒä¸€ä¸ªdomæ–‡æœ¬èŠ‚ç‚¹

```javascript
if (token.type === 'text') {
    if (currentTextNode) {
        currentTextNode.content += token.content;
    } else {
        currentTextNode = {
            type: 'text',
            content: token.content
        }
        top.children.push(currentTextNode);
    }
}
```

æœ€åè¿”å›stackï¼Œå°±å¾—åˆ°æˆ‘ä»¬æœ€ç»ˆçš„domæ ‘äº†ã€‚

```javascript
exports.parseHTML = function (html) {
    let state = data;
    for (const c of html) {
        state = state(c);
    }
    // æœ€åç»™ä¸€ä¸ªæ— æ•ˆçš„å­—ç¬¦ï¼Œè¡¨ç¤ºhtmlçš„ç»ˆç»“
    state = state(EOF);

    return stack[0];
}

```

# ç”Ÿæˆå¸¦CSSå±æ€§çš„DOMæ ‘

CSSè®¡ç®—ï¼šå¯¹CSSè¿›è¡Œè¯æ³•å’Œè¯­æ³•åˆ†æ

## ç¯å¢ƒå‡†å¤‡

```çº¯æ–‡æœ¬
npm install css
```

css parser æŠŠcssä»£ç å˜æˆASTæŠ½è±¡è¯­æ³•æ ‘çš„è¿‡ç¨‹ã€‚

æˆ‘ä»¬çš„è¿‡ç¨‹å°±æ˜¯**ä»ASTæŠ½è±¡è¯­æ³•æ ‘ä¸­æŠ½å‡ºcssè¯­æ³•è§„åˆ™ï¼Œåº”ç”¨åˆ°htmlå…ƒç´ ä¸Šã€‚**

## æ”¶é›†cssè§„åˆ™

- é‡åˆ°styleæ ‡ç­¾æ—¶ï¼ŒæŠŠcssè§„åˆ™ä¿å­˜èµ·æ¥
- è°ƒç”¨css parser å¾—åˆ°cssè§„åˆ™

```javascript
const css = require('css');

// css parserå¤„ç†ï¼Œå¾—åˆ°cssè§„åˆ™
let rules = [];
function addCSSRules(text) {
    let ast = css.parse(text);
    rules.push(...ast.stylesheet.rules);
}
```

```javascript
else if (token.type === 'endTag') { // åŒ¹é…åˆ°ç»“æŸæ ‡ç­¾å‡ºæ ˆ
    if (top.tagName === token.tagName) {
        
        /*é‡åˆ°styleæ ‡ç­¾ï¼Œæ‰§è¡Œcss parser*/
        if (token.tagName === 'style') {
            addCSSRules(top.children[0].content);
        }

        stack.pop();
    } else {
        throw new Error('endTag not match startTag!');
    }

    currentTextNode = null;

}
```

åŸstyle

```css
body div span{
    color: red;
    width: 10px
}
```

æœ€åå¾—åˆ°çš„rulesï¼š

```javascript
{
  type: "rule",
  selectors: [
    "body div span",
  ],
  declarations: [
    {
      type: "declaration",
      property: "color",
      value: "red",
      position: {
        start: {
          line: 3,
          column: 17,
        },
        end: {
          line: 3,
          column: 27,
        },
        source: undefined,
      },
    },
    {
      type: "declaration",
      property: "width",
      value: "10px",
      position: {
        start: {
          line: 4,
          column: 17,
        },
        end: {
          line: 5,
          column: 13,
        },
        source: undefined,
      },
    },
  ],
  position: {
    start: {
      line: 2,
      column: 13,
    },
    end: {
      line: 5,
      column: 14,
    },
    source: undefined,
  },
}
```

## åº”ç”¨cssè§„åˆ™

æ—¶æœºï¼š**ç†è®ºä¸Šï¼Œåœ¨è§£æåˆ°startTagçš„æ—¶å€™å°±å¯ä»¥åŒ¹é…åˆ°cssè§„åˆ™ï¼ˆè¿™é‡Œä¸è€ƒè™‘ï¼‰ã€‚**

æˆ‘çš„é—®é¢˜â“â“â“

æœ¬èŠ‚ç›®æ ‡ï¼šåœ¨startTagçš„æ—¶å€™åˆ¤æ–­åŒ¹é…åˆ°å“ªäº›cssè§„åˆ™äº†ã€‚

![](images/image_FUPfG9vgsH.png)

## è·å–çˆ¶å…ƒç´ åˆ—è¡¨

åœ¨computeCSSå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰å…ƒç´ æ‰€æœ‰çš„çˆ¶å…ƒç´ æ‰èƒ½åˆ¤æ–­å…ƒç´ ä¸è§„åˆ™æ˜¯å¦åŒ¹é…ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡stackæ‹¿åˆ°è¯¥å…ƒç´ æ‰€æœ‰çˆ¶å…ƒç´ ã€‚

```javascript
let elements = stack.slice().reverse();
```

stack.slice()ï¼šå› ä¸ºtagæ ‡ç­¾ä¸€ç›´åœ¨åŠ å…¥åˆ°stackï¼Œä¼šæ±¡æŸ“stackï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ä¸€ä¸ªå½“å‰stackçš„å‰¯æœ¬ã€‚ï¼ˆsliceä¸ä¼šå½±å“åŸæ•°ç»„ï¼Œspliceä¼šã€‚ï¼‰

reverseï¼šå› ä¸ºstacké‡Œé¢å…ƒç´ çš„é¡ºåºæ˜¯`[document, html, body, div]`ï¼Œç°åœ¨åŒ¹é…è§„åˆ™æ˜¯ä»æœ€ååŒ¹é…ï¼Œæ‰€ä»¥è¦åè½¬ä¸€ä¸‹ã€‚

æ¯”å¦‚ä¸‹é¢è§„åˆ™åŒ¹é…çš„æ—¶å€™ï¼Œæœ€å…ˆåŒ¹é…çš„æ˜¯spanï¼ŒåŒ¹é…åˆ°spanåï¼Œæ‰ä¼šç»§ç»­åŒ¹é…på’Œdivã€‚

```css
div p span {}
```

## è®¡ç®—é€‰æ‹©å™¨ä¸å…ƒç´ åŒ¹é…

ï¼ˆä»…ä»…å¤„ç†äº†ç®€å•é€‰æ‹©å™¨åŒ¹é…åˆ¤æ–­ï¼‰

```javascript
/**
 * åº”ç”¨cssè§„åˆ™
 */
function computeCSS(element) {
    console.log('==>', rules);
    let elements = stack.slice().reverse();
    console.log('==>', elements);

    if (!element.computedStyle) {
        element.computedStyle = {};
    }

    for (const rule of rules) {
        // è¿™é‡Œé€‰æ‹©å™¨åªè€ƒè™‘ä»¥ç©ºæ ¼åˆ†éš”çš„ç®€å•é€‰æ‹©å™¨ï¼ˆæ¯”å¦‚ body div spanï¼‰
        let selectorParts = rule.selectors[0].split(' ').reverse(); // ['span', 'div', 'body']

        // æ£€æŸ¥å½“å‰å…ƒç´ ä¸selectorParts[0]æ˜¯å¦åŒ¹é…
        if (match(element, selectorParts[0])) {
            
            let matched = false;

            // å½“å‰å…ƒç´ åŒ¹é…æˆåŠŸåï¼Œå¼€å§‹åŒ¹é…çˆ¶å…ƒç´ ï¼Œå½“æ‰€æœ‰çš„çˆ¶å…ƒç´ åŒ¹é…æˆåŠŸï¼Œæ‰èƒ½è¯´è¿™ä¸ªè§„åˆ™åŒ¹é…æˆåŠŸ
            /**
             * æ¯”å¦‚ body div span
             * é¦–å…ˆåŒ¹é…spanï¼ŒåŒ¹é…å…ƒç´ çš„attribute/å…ƒç´ çš„tagNameæ˜¯å¦æ˜¯span
             * åŒ¹é…åˆ°äº†ååŒ¹é…divå’Œbodyï¼Œçœ‹å…ƒç´ çš„çˆ¶å…ƒç´ çš„attribute/å…ƒç´ çš„tagNameæ˜¯å¦æ˜¯divå’Œbody
             * åªæœ‰å…¨éƒ¨åŒ¹é…äº†ï¼Œé‚£ä¹ˆ`body div span {}` è¿™æ¡è§„åˆ™æ‰æ˜¯æœ‰æ•ˆçš„è§„åˆ™ã€‚
             */
            let j = 1;
            for (let i = 0; i < elements.length; i++) { // elements: [span, p, div, body, html, document]
                if (match(elements[i], selectorParts[j])) { 
                    j++;
                }
            }

            if (j >= selectorParts.length) {
                matched = true;
            }

            if (matched) {
                // ...ç”Ÿæˆè®¡ç®—å±æ€§
            }
        }

    }
}

function match(element, selector) {
    if (!selector || !element.attributes) {
        return false;
    }

    // åªå¤„ç†äº†ç®€å•é€‰æ‹©å™¨
    if (selector.charAt(0) === '#') {
        let attr = element.attributes.filter(attr => attr.name === 'id')[0];
        if (attr && attr.value === selector.replace('#', '')) {
            return true;
        }
    } else if (selector.charAt(0) === '.') {
        let attr = element.attributes.filter(attr => attr.name === 'class')[0];
        if (attr && attr.value === selector.replace('.', '')) {
            return true;
        }
    } else {
        if (element.tagName === selector) {
            return true;
        }
    }

    return false;
} 
```

## ç”Ÿæˆå…ƒç´ çš„computedStyle

å¦‚æœè§„åˆ™åŒ¹é…æˆåŠŸï¼Œåˆ™åœ¨computedStyleä¸­åŠ å…¥è§„åˆ™ï¼Œæ¯”å¦‚ï¼š

```javascript
computedStyle:{
  color:{
    value: 'red'
  }
}
```

ä½†æ˜¯æœ‰å¯èƒ½æœ‰æ ·å¼è¦†ç›–çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦specificityæ¥è·å–ä¼˜å…ˆçº§ã€‚

è®¡ç®—ä¼˜å…ˆçº§è§„åˆ™ï¼šå¼•å…¥å››å…ƒæ•°ç»„ï¼Œåˆ†åˆ«ä»£è¡¨ï¼š

| å†…è”æ ·å¼ | idé€‰æ‹©å™¨ | ç±»é€‰æ‹©å™¨ | tagæ ‡ç­¾ |
| ---- | ----- | ---- | ----- |
|      |       |      |       |

æ¯”å¦‚ï¼š

- body div span ä¼˜å…ˆçº§ä¸ºï¼š\[0,0,0,3]
- body #div span ä¼˜å…ˆçº§ä¸ºï¼š\[0,1,0,2]

compareå‡½æ•°ä¸ºä¼˜å…ˆçº§æ¯”è¾ƒå‡½æ•°ã€‚

å¦‚æœå½“å‰è§„åˆ™çš„ä¼˜å…ˆçº§æ¯”ä¹‹å‰å­˜åœ¨çš„ä¼˜å…ˆçº§é«˜ï¼Œåˆ™è¦†ç›–ã€‚

```javascript
function match(element, selector) {
    if (!selector || !element.attributes) {
        return false;
    }

    // åªå¤„ç†äº†ç®€å•é€‰æ‹©å™¨
    if (selector.charAt(0) === '#') {
        let attr = element.attributes.filter(attr => attr.name === 'id')[0];
        if (attr && attr.value === selector.replace('#', '')) {
            return true;
        }
    } else if (selector.charAt(0) === '.') {
        let attr = element.attributes.filter(attr => attr.name === 'class')[0];
        if (attr && attr.value === selector.replace('.', '')) {
            return true;
        }
    } else {
        if (element.tagName === selector) {
            return true;
        }
    }

    return false;
}

function specificity(selector) { // body div span
    let p = [0, 0, 0, 0] // ä¼˜å…ˆçº§ï¼šinlineï¼Œ#id, .classï¼Œtag
    selector.split(' ').forEach(ele => {
        if (ele.charAt(0) === '#') {
            p[1] += 1;
        } else if (ele.charAt(0) === '.') {
            p[2] += 1;
        } else {
            p[3] += 1;
        }
    });

    return p;
}

// ä¼˜å…ˆçº§æ¯”è¾ƒå‡½æ•°
function compare(sp1, sp2) {
    if (sp1[0] !== sp2[0]) return sp1[0] - sp2[0];
    if (sp1[1] !== sp2[1]) return sp1[1] - sp2[1];
    if (sp1[2] !== sp2[2]) return sp1[2] - sp2[2];
    return sp1[3] - sp2[3];
}

/**
 * åº”ç”¨cssè§„åˆ™
 */
function computeCSS(element) {
    console.log('==>', rules);
    let elements = stack.slice().reverse();
    console.log('==>', elements);

    if (!element.computedStyle) {
        element.computedStyle = {};
    }

    for (const rule of rules) {
        // è¿™é‡Œé€‰æ‹©å™¨åªè€ƒè™‘ä»¥ç©ºæ ¼åˆ†éš”çš„ç®€å•é€‰æ‹©å™¨ï¼ˆæ¯”å¦‚ body div spanï¼‰
        let selectorParts = rule.selectors[0].split(' ').reverse(); // ['span', 'div', 'body']

        // æ£€æŸ¥å½“å‰å…ƒç´ ä¸selectorParts[0]æ˜¯å¦åŒ¹é…
        if (match(element, selectorParts[0])) {
            
            let matched = false;

            // å½“å‰å…ƒç´ åŒ¹é…æˆåŠŸåï¼Œå¼€å§‹åŒ¹é…çˆ¶å…ƒç´ ï¼Œå½“æ‰€æœ‰çš„çˆ¶å…ƒç´ åŒ¹é…æˆåŠŸï¼Œæ‰èƒ½è¯´è¿™ä¸ªè§„åˆ™åŒ¹é…æˆåŠŸ
            /**
             * æ¯”å¦‚ body div span
             * é¦–å…ˆåŒ¹é…spanï¼ŒåŒ¹é…å…ƒç´ çš„attribute/å…ƒç´ çš„tagNameæ˜¯å¦æ˜¯span
             * åŒ¹é…åˆ°äº†ååŒ¹é…divå’Œbodyï¼Œçœ‹å…ƒç´ çš„çˆ¶å…ƒç´ çš„attribute/å…ƒç´ çš„tagNameæ˜¯å¦æ˜¯divå’Œbody
             * åªæœ‰å…¨éƒ¨åŒ¹é…äº†ï¼Œé‚£ä¹ˆ`body div span {}` è¿™æ¡è§„åˆ™æ‰æ˜¯æœ‰æ•ˆçš„è§„åˆ™ã€‚
             */
            let j = 1;
            for (let i = 0; i < elements.length; i++) { // elements: [span, p, div, body, html, document]
                if (match(elements[i], selectorParts[j])) { 
                    j++;
                }
            }

            if (j >= selectorParts.length) {
                matched = true;
            }

            if (matched) {
                let computedStyle = element.computedStyle;

                let sp = specificity(rule.selectors[0]);
                

                for (const declaration of rule.declarations) {
                    if (!computedStyle[declaration.property]) {
                        computedStyle[declaration.property] = {};
                    }

                    // å±æ€§çš„ä¼˜å…ˆçº§
                    if (!computedStyle[declaration.property].specificity) {
                        computedStyle[declaration.property].value = declaration.value;
                        computedStyle[declaration.property].specificity = sp;
                    } else if (compare(sp, computedStyle[declaration.property].specificity) >= 0) { //  ç°åœ¨çš„ä¼˜å…ˆçº§ >= ä»¥å‰çš„ä¼˜å…ˆçº§
                        computedStyle[declaration.property].value = declaration.value;
                        computedStyle[declaration.property].specificity = sp;
                    }
                }
                console.log('==>', computedStyle);
            }
        }

    }
}
```

æœ€ååœ¨client.jsçš„ `let dom = parser.parseHTML(response.body);` è¿”å›å€¼å°±æ˜¯å¸¦æœ‰cssæ ·å¼çš„domæ•°ã€‚

```json
// ä¸€ä¸ªspançš„computedStyleå¦‚ä¸‹ï¼š

{
  color: {
    value: "green",
    specificity: [ 0, 1, 0, 1],
  },
  width: {
    value: "20px",
    specificity: [ 0, 1, 0, 1],
  },
}
```

æ•´ä¸ªç”Ÿæˆå¸¦æœ‰csså±æ€§çš„domæ ‘å®Œæˆã€‚


# ç”Ÿæˆå¸¦ä½ç½®çš„DOMæ ‘

# æ’ç‰ˆç®—æ³•

ç¬¬ä¸€ä»£æ’ç‰ˆï¼špositionï¼Œdisplayï¼Œfloat

ç¬¬äºŒä»£æ’ç‰ˆï¼šflex

ç¬¬ä¸‰ä»£æ’ç‰ˆï¼šgrid

ç¬¬å››ä»£æ’ç‰ˆï¼ˆé¢„æµ‹ï¼‰ï¼šCSS Houdini

## flexæ’ç‰ˆ

é€‰æ‹©flexæ’ç‰ˆæ˜¯å› ä¸ºå®¹æ˜“å®ç°ï¼Œè€Œä¸”èƒ½åŠ›ä¸ä¼šå¤ªå·®ã€‚

ä¸»è½´ï¼šMain Axis

äº¤å‰è½´ï¼šCross Axis

å¦‚æœä¸»è½´çš„æ–¹å‘æ˜¯`flex-direction: row;`

ç›¸å…³çš„å±æ€§æœ‰ï¼š

- ä¸»è½´ï¼šwidthï¼Œxï¼Œleftï¼Œright
- äº¤å‰è½´ï¼šheightï¼Œyï¼Œtopï¼Œbottom

å¦‚æœä¸»è½´çš„æ–¹å‘æ˜¯`flex-direction: column;`åˆ™åä¹‹ã€‚

## æ’ç‰ˆçš„æ—¶æœº

æˆ‘çš„é—®é¢˜â“â“â“

**å½“åŒ¹é…åˆ°ç»“æŸæ ‡ç­¾çš„æ—¶å€™ï¼Œå°±éœ€è¦è¿›è¡Œæ’ç‰ˆã€‚**

1ã€åšæŠ½è±¡çš„å·¥ä½œï¼ŒæŠŠwidthï¼Œleftç­‰å±æ€§æŠ½è±¡æˆmainï¼Œcrossç­‰å±æ€§

2ã€æŠŠå…ƒç´ æ”¶è¿›â€œè¡Œâ€å†…

## æ”¶é›†å…ƒç´ è¿›è¡Œ

**å½“æ‰€æœ‰å­å…ƒç´ ä¸»è½´æ–¹å‘å°ºå¯¸ä¹‹å’Œå¤§äºçˆ¶å…ƒç´ ä¸»è½´å°ºå¯¸çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œåˆ†è¡Œå¤„ç†ã€‚**

- å¦‚æœè®¾ç½®äº†no-warpï¼Œåˆ™æŠŠæ‰€æœ‰å­å…ƒç´ å¼ºè¡Œåˆ†é…è¿›ç¬¬ä¸€è¡Œ
- å¦‚æœæœªè®¾ç½®no-warpï¼Œåˆ™å½“ä¸€ä¸ªå­å…ƒç´ æ”¾å…¥æ—¶ï¼Œå½“å‰è¡Œçš„å‰©ä½™ç©ºé—´ä¸è¶³ä»¥å®¹çº³è¯¥å­å…ƒç´ æ—¶ï¼Œåˆ™å¦èµ·ä¸€è¡Œæ”¾å…¥ï¼Œå¦èµ·çš„è¿™ä¸€è¡Œå˜ä¸ºå½“å‰è¡Œï¼Œå¹¶ä¸”æœ‰è¾ƒå¤šçš„å‰©ä½™ç©ºé—´
- ä»¥æ­¤ç±»æ¨ï¼ŒæŠŠæ‰€æœ‰çš„å­å…ƒç´ æ”¶é›†è¿›ä¸åŒçš„è¡Œä¸­

## è®¡ç®—ä¸»è½´

> å¦‚æœæ˜¯rowçš„è¯ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—widthï¼Œleftï¼Œright

åˆ¤æ–­ä¸»è½´å‰©ä½™ç©ºé—´`mainSpace`æ˜¯å¦ä¸ºè´Ÿï¼š

- **ä¸ºè´Ÿï¼Œåˆ™åªæœ‰ä¸€è¡Œï¼ˆno-wrapï¼‰**
  - å¸¦æœ‰flexå±æ€§çš„å…ƒç´ ï¼Œä¸»è½´æ–¹å‘é•¿åº¦ä¸º0
  - ä¸å¸¦æœ‰flexå±æ€§çš„å…ƒç´ ï¼Œè¿›è¡Œç­‰æ¯”ç¼©æ”¾
- **ä¸ä¸ºè´Ÿï¼ˆæœ‰å‰©ä½™ç©ºé—´ï¼‰**
  - æŸ¥æ‰¾æ¯ä¸€è¡Œçš„å…ƒç´ æ˜¯å¦æœ‰flexå±æ€§
    - æœ‰ï¼ŒæŠŠå‰©ä½™ç©ºé—´mainSpaceåˆ†ç»™flexå…ƒç´ ï¼ˆæ¯”å¦‚å¦‚æœæœ‰ä¸¤ä¸ªå­å…ƒç´ flexå±æ€§åˆ†åˆ«æ˜¯1ï¼Œ2çš„è¯ï¼Œåˆ†é…çš„å‰©ä½™ç©ºé—´å æ¯”æ˜¯1/3å’Œ2/3ï¼‰
    - æ²¡æœ‰ï¼Œæ ¹æ®justifyContentå±æ€§è¿›è¡Œå¸ƒå±€ï¼Œå–å¾—èµ·å§‹ä½ç½®currentMainå’Œå­å…ƒç´ çš„é—´è·stepï¼Œç„¶åè®¡ç®—æ¯ä¸ªå­å…ƒç´ åœ¨ä¸»è½´æ–¹å‘çš„ä½ç½®ã€‚

## è®¡ç®—äº¤å‰è½´

> å¦‚æœæ˜¯rowçš„è¯ï¼Œè®¡ç®—heightï¼Œtopï¼Œbottom

[align-itemså’Œalign-contentçš„åŒºåˆ«\_ç é£\_CCçš„åšå®¢-CSDNåšå®¢ æ–‡ç« ç›®å½•1. stack overflowä¸Šçš„å›ç­”ï¼ˆç¿»è¯‘ï¼‰2. è‡ªå·±åŠ¨æ‰‹å®è·µ2.1 å­é¡¹ä¸ºå•è¡Œçš„æƒ…å†µ2.1.1 flexå®¹å™¨ä¸è®¾ç½®é«˜åº¦2.1.2 flexå®¹å™¨è®¾ç½®é«˜åº¦2.2 å­é¡¹ä¸ºå¤šè¡Œçš„æƒ…å†µ2.2.1 flexå®¹å™¨ä¸è®¾ç½®é«˜åº¦2.2.2 flexå®¹å™¨è®¾ç½®é«˜åº¦3. æ€»ç»“åœ¨ç”¨flexå¸ƒå±€æ—¶ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå±æ€§åŠŸèƒ½å¥½åƒæœ‰ç‚¹ç±»ä¼¼ï¼šalign-itemså’Œalign-contentï¼Œä¹çœ‹ä¹‹ä¸‹ï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨äºå®šä¹‰f... https://blog.csdn.net/cc18868876837/article/details/88138057](https://blog.csdn.net/cc18868876837/article/details/88138057 "align-itemså’Œalign-contentçš„åŒºåˆ«_ç é£_CCçš„åšå®¢-CSDNåšå®¢ æ–‡ç« ç›®å½•1. stack overflowä¸Šçš„å›ç­”ï¼ˆç¿»è¯‘ï¼‰2. è‡ªå·±åŠ¨æ‰‹å®è·µ2.1 å­é¡¹ä¸ºå•è¡Œçš„æƒ…å†µ2.1.1 flexå®¹å™¨ä¸è®¾ç½®é«˜åº¦2.1.2 flexå®¹å™¨è®¾ç½®é«˜åº¦2.2 å­é¡¹ä¸ºå¤šè¡Œçš„æƒ…å†µ2.2.1 flexå®¹å™¨ä¸è®¾ç½®é«˜åº¦2.2.2 flexå®¹å™¨è®¾ç½®é«˜åº¦3. æ€»ç»“åœ¨ç”¨flexå¸ƒå±€æ—¶ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå±æ€§åŠŸèƒ½å¥½åƒæœ‰ç‚¹ç±»ä¼¼ï¼šalign-itemså’Œalign-contentï¼Œä¹çœ‹ä¹‹ä¸‹ï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨äºå®šä¹‰f... https://blog.csdn.net/cc18868876837/article/details/88138057")

`align-items`ï¼šæ¯ä¸€è¡Œçš„å…ƒç´ åœ¨äº¤å‰è½´çš„æ’å¸ƒ

`align-content`ï¼šæ‰€æœ‰è¡Œåœ¨äº¤å‰è½´å‰©ä½™ç©ºé—´çš„æ’å¸ƒ

![align-items: center](images/image_hNA8jga6nc.png "align-items: center")

![align-content: center](images/image_oxpAO_veg2.png "align-content: center")

## ç»˜åˆ¶å…ƒç´ 

å¦‚ä½•ç»˜åˆ¶ï¼Ÿ

å‡†å¤‡å›¾å½¢ç¯å¢ƒï¼Œç”±äºNode.jsæ²¡æœ‰å›¾å½¢å°è£…çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ç”Ÿæˆå›¾ç‰‡æ¥ä»£æ›¿ï¼ŒæŠŠç»˜åˆ¶åˆ°å±å¹•å˜æˆç»˜åˆ¶åˆ°å›¾ç‰‡ã€‚

npmä¸‹æœ‰ä¸ª[images](https://www.npmjs.com/package/images "images")åº“ï¼š**Node.jsè½»é‡çº§è·¨å¹³å°å›¾åƒç¼–è§£ç åº“**

åŠŸèƒ½ç‰¹æ€§

- è½»é‡çº§ï¼šæ— éœ€å®‰è£…ä»»ä½•å›¾åƒå¤„ç†åº“ã€‚
- è·¨å¹³å°ï¼šWindowsä¸‹å‘å¸ƒäº†ç¼–è¯‘å¥½çš„.nodeæ–‡ä»¶,ä¸‹è½½å°±èƒ½ç”¨ã€‚
- æ–¹ä¾¿ç”¨ï¼šjQueryé£æ ¼çš„APIï¼Œç®€å•å¯ä¾èµ–ã€‚

å®‰è£…

```çº¯æ–‡æœ¬
npm install images
```

ä½¿ç”¨

```javascript
var images = require("images");
 
images("input.jpg")                     //Load image from file 
                                        //åŠ è½½å›¾åƒæ–‡ä»¶
    .size(400)                          //Geometric scaling the image to 400 pixels width
                                        //ç­‰æ¯”ç¼©æ”¾å›¾åƒåˆ°400åƒç´ å®½
    .draw(images("logo.png"), 10, 10)   //Drawn logo at coordinates (10,10)
                                        //åœ¨(10,10)å¤„ç»˜åˆ¶Logo
    .save("output.jpg", {               //Save the image to a file, with the quality of 50
        quality : 50                    //ä¿å­˜å›¾ç‰‡åˆ°æ–‡ä»¶,å›¾ç‰‡è´¨é‡ä¸º50
    });
```


# é—®é¢˜æ± 

æˆ‘çš„é—®é¢˜â“â“â“

htmlæœ€åæ˜¯æœ‰ä¸€ä¸ªæ–‡ä»¶ç»ˆç»“çš„ï¼Œä½†æ˜¯åœ¨æ–‡ä»¶ç»ˆç»“çš„ä½ç½®ï¼Œæ¯”å¦‚è¯´æœ‰ä¸€äº›æ–‡æœ¬èŠ‚ç‚¹å¯èƒ½ä»ç„¶é¢ä¸´æ²¡æœ‰ç»ˆç»“çš„çŠ¶æ€ï¼Œæ‰€ä»¥æœ€åç»™å®ƒä¸€ä¸ªé¢å¤–çš„æ— æ•ˆçš„å­—ç¬¦ï¼Œè¡¨ç¤ºhtmlçš„ç»ˆç»“ï¼Ÿï¼Ÿ

å•¥æ„æ€?

å›ç­”ï¼šæ¯”å¦‚`<html><body>å“ˆå“ˆå“ˆ`æ˜¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºçš„htmlæ–‡ä»¶ï¼Œå…¶æ–‡æœ¬èŠ‚ç‚¹å°±æ²¡æœ‰ç»ˆç»“ã€‚



æˆ‘çš„é—®é¢˜â“â“â“

1ã€å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œä¼šç«‹å³è®¡ç®—cssï¼Œå‡è®¾æ‰€æœ‰çš„csså·²ç»æ”¶é›†å®Œæ¯•ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ ·æ‰€æœ‰çš„headé‡Œé¢çš„å…ƒç´ æˆ‘ä»¬æ˜¯æ— æ³•è®¡ç®—å…¶cssçš„ã€‚

åœ¨toy-broswerä¸­å°±å‡è®¾headé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿é»˜è®¤éƒ½ä¸æ˜¾ç¤ºï¼Œæœ€å¤–å±‚çš„htmlæˆ‘ä»¬ä¹Ÿä¸ä¼šç»™å®ƒæ·»åŠ ä»»ä½•çš„æ ·å¼ï¼Œæˆ‘ä»¬å°±è¿™æ ·å‡è®¾å¥½äº†ã€‚

å›ç­”ï¼šç”±äºcomputeCSS(element);é‡Œé¢éœ€è¦åˆ¤æ–­rulesæ˜¯å¦æœ‰å€¼ï¼Œä½†æ˜¯rulesæœ‰å€¼çš„æ—¶å€™å·²ç»åˆ°</style>äº†ï¼Œç„¶ååœ¨è¿›å…¥computeCSSçš„æ—¶å€™å·²ç»åˆ°<body>äº†ï¼Œæ‰€ä»¥æ‰æœ‰ä¹‹å‰è¯´çš„htmlå’Œheadé‡Œé¢çš„å…ƒç´ æ˜¯æ— æ³•è®¡ç®—cssçš„ï¼Œå› ä¸ºå·²ç»è·‘è¿‡å»äº†ã€‚

2ã€åœ¨çœŸå®æµè§ˆå™¨ä¸­å¯èƒ½ä¼šé‡åˆ°å†™åœ¨bodyçš„styleæ ‡ç­¾ï¼Œéœ€è¦é‡æ–°cssè®¡ç®—çš„æƒ…å†µï¼Œè¿™é‡Œä¹Ÿå¿½ç•¥ã€‚

styleå¯ä»¥å†™åœ¨bodyä¸­ï¼Ÿstyleæ ‡ç­¾å†™åœ¨bodyåä¸bodyå‰æœ‰ä»€ä¹ˆåŒºåˆ«?

å›ç­”ï¼šå†™åœ¨bodyæ ‡ç­¾åç”±äºæµè§ˆå™¨ä»¥é€è¡Œæ–¹å¼å¯¹htmlæ–‡æ¡£è¿›è¡Œè§£æï¼Œå½“è§£æåˆ°å†™åœ¨å°¾éƒ¨çš„æ ·å¼è¡¨ï¼ˆå¤–è”æˆ–å†™åœ¨styleæ ‡ç­¾ï¼‰ä¼šå¯¼è‡´æµè§ˆå™¨åœæ­¢ä¹‹å‰çš„æ¸²æŸ“ï¼Œç­‰å¾…åŠ è½½ä¸”è§£ææ ·å¼è¡¨å®Œæˆä¹‹åé‡æ–°æ¸²æŸ“ï¼Œåœ¨windowsçš„IEä¸‹å¯èƒ½ä¼šå‡ºç°FOUCç°è±¡ï¼ˆå³æ ·å¼å¤±æ•ˆå¯¼è‡´çš„é¡µé¢é—ªçƒé—®é¢˜ï¼‰

ä¹‹æ‰€ä»¥å»ºè®®styleæ ‡ç­¾å†™åœ¨bodyå‰ï¼Œæ˜¯å› ä¸ºå½“ä½ åœ¨å‰é¢å£°æ˜cssæ—¶<body>å¼€å§‹æ—¶ï¼Œä½ çš„æ ·å¼å®é™…ä¸Šå·²ç»åŠ è½½äº†ã€‚æ‰€ä»¥ç”¨æˆ·å¾ˆå¿«å°±ä¼šçœ‹åˆ°å±å¹•ä¸Šå‡ºç°çš„ä¸œè¥¿(ä¾‹å¦‚èƒŒæ™¯è‰²)ã€‚å¦‚æœæ²¡æœ‰ï¼Œç”¨æˆ·ä¼šåœ¨CSSåˆ°è¾¾ç”¨æˆ·ä¹‹å‰çœ‹åˆ°ä¸€æ®µæ—¶é—´çš„ç©ºç™½å±å¹•ã€‚

æ­¤å¤–ï¼Œå¦‚æœå°†æ ·å¼æ”¾åœ¨<body>ï¼Œå½“å·²å£°æ˜çš„æ ·å¼è¢«è§£ææ—¶ï¼Œæµè§ˆå™¨å¿…é¡»é‡æ–°å‘ˆç°é¡µé¢(åŠ è½½æ—¶æ–°çš„å’Œæ—§çš„)ã€‚

https://www.zhihu.com/question/39840003/answer/181308294


æˆ‘çš„é—®é¢˜â“â“â“

å› ä¸ºflexå¸ƒå±€å®ƒéœ€è¦çŸ¥é“å­å…ƒç´ çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºå®ƒçš„å­å…ƒç´ ä¸€å®šæ˜¯å‘ç”Ÿåœ¨æ ‡ç­¾çš„ç»“æŸæ ‡ç­¾ä¹‹å‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©çš„æ—¶æœºå°±æ˜¯`token.type==="endTag"`çš„æ—¶å€™ã€‚